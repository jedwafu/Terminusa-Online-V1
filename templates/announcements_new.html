<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Announcements - Terminusa Online</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/main.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/announcements.css') }}">
</head>
<body>
    <header class="header">
        <div class="container header-content">
            <a href="https://terminusa.online" class="logo">Terminusa Online</a>
            <nav class="nav-menu">
                <a href="https://terminusa.online" class="nav-link">Home</a>
                <a href="{{ url_for('marketplace_page') }}" class="nav-link">Marketplace</a>
                <a href="{{ url_for('leaderboard_page') }}" class="nav-link">Leaderboard</a>
                {% if is_authenticated %}
                    <a href="https://play.terminusa.online" class="nav-link">Play Now</a>
                {% endif %}
            </nav>
            <div class="auth-buttons">
                {% if is_authenticated %}
                    <a href="https://play.terminusa.online" class="btn btn-primary">Play Now</a>
                    <button onclick="logout()" class="btn btn-secondary">Logout</button>
                {% else %}
                    <a href="{{ url_for('login_page') }}" class="btn btn-secondary">Login</a>
                    <a href="{{ url_for('register_page') }}" class="btn btn-primary">Register</a>
                {% endif %}
            </div>
        </div>
    </header>

    <main class="main-content">
        <div class="container">
            <h1>Manage Announcements</h1>
            {% if current_user and current_user.role == 'admin' %}
            <form id="announcement-form" class="admin-only">
                <input type="hidden" id="announcement-id">
                <input type="text" id="title" placeholder="Title" required>
                <textarea id="content" placeholder="Content" required></textarea>
                <div class="form-buttons">
                    <button type="submit" id="submit-btn" class="btn btn-primary">Create Announcement</button>
                    <button type="button" id="cancel-btn" class="btn btn-secondary" style="display: none;">Cancel</button>
                </div>
            </form>
            {% endif %}

            <h2>Current Announcements</h2>
            <div id="announcement-list">
                {% for announcement in announcements %}
                <div class="announcement-item" data-id="{{ announcement.id }}">
                    <div class="announcement-header">
                        <h3>{{ announcement.title }}</h3>
                        <span class="announcement-date">{{ announcement.created_at.strftime('%Y-%m-%d %H:%M') }}</span>
                    </div>
                    <p>{{ announcement.content }}</p>
                    {% if current_user and current_user.role == 'admin' %}
                    <div class="announcement-actions admin-only">
                        <button onclick="editAnnouncement({{ announcement.id }})" class="btn btn-secondary">Edit</button>
                        <button onclick="deleteAnnouncement({{ announcement.id }})" class="btn btn-danger">Delete</button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
        </div>
    </main>

    <footer class="footer">
        <div class="container footer-content">
            <div class="footer-links">
                <a href="#" class="footer-link">About</a>
                <a href="#" class="footer-link">Terms</a>
                <a href="#" class="footer-link">Privacy</a>
                <a href="#" class="footer-link">Support</a>
            </div>
            <div class="copyright">
                Â© 2025 Terminusa Online. All rights reserved.
            </div>
        </div>
    </footer>

    <script>
        let isEditing = false;
        const form = document.getElementById('announcement-form');
        const submitBtn = document.getElementById('submit-btn');
        const cancelBtn = document.getElementById('cancel-btn');
        const titleInput = document.getElementById('title');
        const contentInput = document.getElementById('content');
        const idInput = document.getElementById('announcement-id');

        if (form) {
            form.addEventListener('submit', async function(e) {
                e.preventDefault();
                const title = titleInput.value;
                const content = contentInput.value;
                const id = idInput.value;

                const method = isEditing ? 'PUT' : 'POST';
                const url = isEditing ? `/api/announcements/${id}` : '/api/announcements';

                try {
                    const response = await fetch(url, {
                        method,
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('token')}`
                        },
                        body: JSON.stringify({ title, content })
                    });

                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }

                    const data = await response.json();
                    showNotification(data.message, 'success');
                    resetForm();
                    location.reload();
                } catch (error) {
                    console.error('Error:', error);
                    showNotification('Failed to save announcement', 'error');
                }
            });
        }

        if (cancelBtn) {
            cancelBtn.addEventListener('click', resetForm);
        }

        async function editAnnouncement(id) {
            try {
                const response = await fetch(`/api/announcements/${id}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                if (data.status === 'success') {
                    const announcement = data.announcement;
                    titleInput.value = announcement.title;
                    contentInput.value = announcement.content;
                    idInput.value = announcement.id;
                    submitBtn.textContent = 'Update Announcement';
                    cancelBtn.style.display = 'inline-block';
                    isEditing = true;
                    form.scrollIntoView({ behavior: 'smooth' });
                }
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to load announcement', 'error');
            }
        }

        async function deleteAnnouncement(id) {
            if (!confirm('Are you sure you want to delete this announcement?')) {
                return;
            }

            try {
                const response = await fetch(`/api/announcements/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }

                const data = await response.json();
                showNotification(data.message, 'success');
                location.reload();
            } catch (error) {
                console.error('Error:', error);
                showNotification('Failed to delete announcement', 'error');
            }
        }

        function resetForm() {
            if (form) {
                form.reset();
                idInput.value = '';
                submitBtn.textContent = 'Create Announcement';
                cancelBtn.style.display = 'none';
                isEditing = false;
            }
        }

        function showNotification(message, type) {
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.classList.add('show');
            }, 100);

            setTimeout(() => {
                notification.classList.remove('show');
                setTimeout(() => {
                    notification.remove();
                }, 300);
            }, 3000);
        }
    </script>
</body>
</html>
