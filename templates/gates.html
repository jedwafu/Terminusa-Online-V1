{% extends "base.html" %}

{% block title %}Terminusa Online - Gates{% endblock %}

{% block extra_css %}
<style>
    .gates-container {
        display: grid;
        grid-template-columns: 300px 1fr;
        gap: 1rem;
    }

    .player-info {
        background-color: var(--secondary-color);
        padding: 1rem;
        border-radius: 0.5rem;
    }

    .gates-list {
        background-color: var(--secondary-color);
        padding: 1rem;
        border-radius: 0.5rem;
    }

    .gate-card {
        background-color: var(--primary-color);
        border: 1px solid var(--accent-color);
        border-radius: 0.5rem;
        padding: 1rem;
        margin-bottom: 1rem;
        transition: transform 0.2s;
    }

    .gate-card:hover {
        transform: translateY(-2px);
    }

    .gate-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
    }

    .gate-grade {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-weight: bold;
    }

    .grade-E { background-color: #95a5a6; }
    .grade-D { background-color: #27ae60; }
    .grade-C { background-color: #2980b9; }
    .grade-B { background-color: #8e44ad; }
    .grade-A { background-color: #e74c3c; }
    .grade-S { background-color: #f1c40f; }
    .grade-SS { background-color: #e67e22; }
    .grade-SSS { background-color: #c0392b; }

    .gate-info {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .info-item {
        text-align: center;
        padding: 0.5rem;
        background-color: var(--secondary-color);
        border-radius: 0.25rem;
    }

    .gate-rewards {
        display: flex;
        gap: 1rem;
        margin-bottom: 1rem;
    }

    .reward-item {
        display: flex;
        align-items: center;
        gap: 0.25rem;
    }

    .currency-icon {
        width: 20px;
        height: 20px;
    }

    .party-members {
        display: flex;
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .party-member {
        background-color: var(--secondary-color);
        padding: 0.5rem;
        border-radius: 0.25rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }

    .member-status {
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .status-alive { background-color: #27ae60; }
    .status-dead { background-color: #c0392b; }

    .combat-log {
        height: 200px;
        background-color: var(--primary-color);
        padding: 0.5rem;
        border-radius: 0.25rem;
        overflow-y: auto;
        margin-bottom: 1rem;
    }

    .log-entry {
        margin-bottom: 0.25rem;
        padding: 0.25rem;
        border-radius: 0.25rem;
    }

    .log-damage { color: #e74c3c; }
    .log-heal { color: #27ae60; }
    .log-status { color: #f1c40f; }
    .log-death { color: #95a5a6; }

    .modal-content {
        background-color: var(--secondary-color);
        color: var(--text-color);
    }

    .modal-header {
        border-bottom-color: var(--accent-color);
    }

    .modal-footer {
        border-top-color: var(--accent-color);
    }

    .player-stats {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 0.5rem;
        margin-bottom: 1rem;
    }

    .stat-item {
        background-color: var(--primary-color);
        padding: 0.5rem;
        border-radius: 0.25rem;
        text-align: center;
    }

    .stat-value {
        font-size: 1.2rem;
        font-weight: bold;
        color: var(--accent-color);
    }
</style>
{% endblock %}

{% block content %}
<div class="gates-container">
    <!-- Left Sidebar - Player Info -->
    <div class="player-info">
        <h4>{{ user.username }}</h4>
        <p>Level {{ user.level }} {{ user.job_class }}</p>

        <div class="player-stats">
            <div class="stat-item">
                <div class="stat-value">{{ user.strength }}</div>
                <div>Strength</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ user.agility }}</div>
                <div>Agility</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ user.intelligence }}</div>
                <div>Intelligence</div>
            </div>
            <div class="stat-item">
                <div class="stat-value">{{ user.luck }}</div>
                <div>Luck</div>
            </div>
        </div>

        {% if user.party %}
            <h5>Your Party</h5>
            <div class="party-members">
                {% for member in user.party.members %}
                    <div class="party-member">
                        <div class="member-status status-{{ 'alive' if member.hp > 0 else 'dead' }}"></div>
                        <span>{{ member.username }}</span>
                        <small>Lv.{{ member.level }}</small>
                    </div>
                {% endfor %}
            </div>
            {% if user.id == user.party.leader_id %}
                <button class="btn btn-primary btn-sm w-100 mb-2" onclick="inviteToParty()">Invite Member</button>
            {% endif %}
            <button class="btn btn-danger btn-sm w-100" onclick="leaveParty()">Leave Party</button>
        {% else %}
            <button class="btn btn-primary w-100 mb-2" onclick="createParty()">Create Party</button>
            <button class="btn btn-primary w-100" onclick="showPartyList()">Join Party</button>
        {% endif %}
    </div>

    <!-- Main Content - Gates List -->
    <div class="gates-list">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h4>Available Gates</h4>
            <select class="form-select w-auto" id="gradeFilter">
                <option value="all">All Grades</option>
                <option value="E">Grade E</option>
                <option value="D">Grade D</option>
                <option value="C">Grade C</option>
                <option value="B">Grade B</option>
                <option value="A">Grade A</option>
                <option value="S">Grade S</option>
                <option value="SS">Grade SS</option>
                <option value="SSS">Grade SSS</option>
            </select>
        </div>

        {% for gate in available_gates %}
            <div class="gate-card" data-grade="{{ gate.grade }}">
                <div class="gate-header">
                    <div>
                        <span class="gate-grade grade-{{ gate.grade }}">{{ gate.grade }}</span>
                        <h5 class="d-inline ms-2">{{ gate.name }}</h5>
                    </div>
                    <button class="btn btn-primary" onclick="enterGate({{ gate.id }})">Enter Gate</button>
                </div>

                <div class="gate-info">
                    <div class="info-item">
                        <div>Min Level</div>
                        <strong>{{ gate.min_level }}</strong>
                    </div>
                    <div class="info-item">
                        <div>Max Players</div>
                        <strong>{{ gate.max_players }}</strong>
                    </div>
                    <div class="info-item">
                        <div>Time Limit</div>
                        <strong>30:00</strong>
                    </div>
                </div>

                <div class="gate-rewards">
                    <div class="reward-item">
                        <img src="/static/images/crystal.png" class="currency-icon" alt="CRYS">
                        <span>{{ gate.crystal_reward }}</span>
                    </div>
                </div>

                <small>Magic Beasts: {{ gate.magic_beasts|length }}</small>
            </div>
        {% endfor %}
    </div>
</div>

<!-- Active Gate Modal -->
<div class="modal fade" id="activeGateModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Gate Combat</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="party-members mb-3">
                    <!-- Party members will be inserted here -->
                </div>

                <div class="combat-log">
                    <!-- Combat log entries will be inserted here -->
                </div>

                <div class="progress mb-3">
                    <div class="progress-bar bg-danger" role="progressbar" style="width: 100%"></div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-danger" onclick="exitGate()">Exit Gate</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    let activeGateId = null;
    let combatInterval = null;

    // Filter gates by grade
    document.getElementById('gradeFilter').addEventListener('change', function() {
        const grade = this.value;
        document.querySelectorAll('.gate-card').forEach(card => {
            if (grade === 'all' || card.dataset.grade === grade) {
                card.style.display = 'block';
            } else {
                card.style.display = 'none';
            }
        });
    });

    function enterGate(gateId) {
        fetch(`/gates/${gateId}/enter`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                activeGateId = gateId;
                showActiveGate(result.gate_state);
            } else {
                showAlert(result.message, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error entering gate', 'danger');
            console.error('Error:', error);
        });
    }

    function showActiveGate(gateState) {
        const modal = new bootstrap.Modal(document.getElementById('activeGateModal'));
        updatePartyStatus(gateState.party);
        startCombatSimulation();
        modal.show();
    }

    function updatePartyStatus(party) {
        const partyContainer = document.querySelector('#activeGateModal .party-members');
        partyContainer.innerHTML = party.map(member => `
            <div class="party-member">
                <div class="member-status status-${member.hp > 0 ? 'alive' : 'dead'}"></div>
                <span>${member.username}</span>
                <small>${member.hp}/${member.max_hp} HP</small>
            </div>
        `).join('');
    }

    function startCombatSimulation() {
        const logContainer = document.querySelector('#activeGateModal .combat-log');
        const progressBar = document.querySelector('#activeGateModal .progress-bar');
        let timeLeft = 1800; // 30 minutes in seconds

        combatInterval = setInterval(() => {
            timeLeft--;
            const progress = (timeLeft / 1800) * 100;
            progressBar.style.width = `${progress}%`;

            // Simulate combat events
            if (Math.random() < 0.2) { // 20% chance each second
                const eventType = Math.random();
                let logEntry;

                if (eventType < 0.6) { // 60% damage
                    logEntry = `<div class="log-entry log-damage">Magic Beast deals 150 damage to Player</div>`;
                } else if (eventType < 0.8) { // 20% heal
                    logEntry = `<div class="log-entry log-heal">Healer restores 100 HP to Player</div>`;
                } else { // 20% status effect
                    logEntry = `<div class="log-entry log-status">Player is affected by Poison</div>`;
                }

                logContainer.innerHTML += logEntry;
                logContainer.scrollTop = logContainer.scrollHeight;
            }

            if (timeLeft <= 0) {
                clearInterval(combatInterval);
                exitGate();
            }
        }, 1000);
    }

    function exitGate() {
        if (combatInterval) {
            clearInterval(combatInterval);
        }

        fetch(`/gates/${activeGateId}/exit`, {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                location.reload();
            } else {
                showAlert(result.message, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error exiting gate', 'danger');
            console.error('Error:', error);
        });
    }

    function createParty() {
        const name = prompt('Enter party name:');
        if (!name) return;

        fetch('/party/create', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ name })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                location.reload();
            } else {
                showAlert(result.message, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error creating party', 'danger');
            console.error('Error:', error);
        });
    }

    function showPartyList() {
        fetch('/party/list', {
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                // Show party list in a modal
                const parties = result.parties;
                // Implementation for displaying parties
            } else {
                showAlert(result.message, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error fetching party list', 'danger');
            console.error('Error:', error);
        });
    }

    function inviteToParty() {
        const username = prompt('Enter player username:');
        if (!username) return;

        fetch('/party/invite', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            },
            body: JSON.stringify({ username })
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                showAlert('Invitation sent successfully');
            } else {
                showAlert(result.message, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error sending invitation', 'danger');
            console.error('Error:', error);
        });
    }

    function leaveParty() {
        if (!confirm('Are you sure you want to leave the party?')) {
            return;
        }

        fetch('/party/leave', {
            method: 'POST',
            headers: {
                'Authorization': `Bearer ${localStorage.getItem('token')}`
            }
        })
        .then(response => response.json())
        .then(result => {
            if (result.status === 'success') {
                location.reload();
            } else {
                showAlert(result.message, 'danger');
            }
        })
        .catch(error => {
            showAlert('Error leaving party', 'danger');
            console.error('Error:', error);
        });
    }

    // Clean up when leaving the page
    window.addEventListener('beforeunload', () => {
        if (combatInterval) {
            clearInterval(combatInterval);
        }
    });
</script>
{% endblock %}
